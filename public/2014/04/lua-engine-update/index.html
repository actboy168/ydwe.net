<!DOCTYPE html><html><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> Lua引擎兼容性修改指导 · YDWE官方博客</title><meta name="description" content="Lua引擎兼容性修改指导 - actboy168"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="icon" href="/favicon.png"><link rel="stylesheet" href="/css/apollo.css"><link rel="search" type="application/opensearchdescription+xml" href="http://www.ydwe.net/atom.xml" title="YDWE官方博客"></head><body><div class="wrap"><header><a href="/" class="logo-link"><img src="/favicon.png" alt="logo"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/" target="_self" class="nav-list-link">主页</a></li><li class="nav-list-item"><a href="/archives/" target="_self" class="nav-list-link">目录</a></li><li class="nav-list-item"><a href="/download.html" target="_self" class="nav-list-link">下载</a></li><li class="nav-list-item"><a href="https://github.com/actboy168/YDWE" target="_blank" class="nav-list-link">GITHUB</a></li></ul></header><main class="container"><div class="post"><article class="post-block"><h1 class="post-title">Lua引擎兼容性修改指导</h1><div class="post-info">Apr 3, 2014</div><div class="post-content"><p>刚开始做Lua引擎时，只是抱着玩玩的心态，很多东西没有认真地设计。所以在YDWE1.27，Lua引擎进行了大规模的修改，为了确保你的代码可以顺利过渡到1.28以上的YDWE，请仔细阅读文本。注：1.27支持新旧两种写法，但1.28只会支持新写法。</p>
<a id="more"></a>
<p>##Lua引擎加载</p>
<p>旧写法<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">call Cheat(&quot;run main.lua&quot;)</div></pre></td></tr></table></figure></p>
<p>新写法<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">call Cheat(&quot;exec-lua: &apos;main.lua&apos;&quot;)</div><div class="line">call Cheat(&quot;exec-lua: \&quot;main.lua\&quot;&quot;)</div><div class="line">call Cheat(&quot;exec-lua: main.lua&quot;)</div><div class="line">call Cheat(&quot;exec-lua:main.lua&quot;)</div><div class="line">call Cheat(&quot;exec-lua: main.lua &quot;)</div></pre></td></tr></table></figure></p>
<p>新写法中可以让你的代码看起来更清晰，同时也更加灵活.</p>
<p>##内置库不再默认加载</p>
<p>旧写法</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">jass.DisplayTimedTextToPlayer(cj.GetLocalPlayer(), <span class="number">0</span>, <span class="number">0</span>, <span class="number">60.</span>, <span class="string">'hello'</span>)</div></pre></td></tr></table></figure>
<p>新写法<br><figure class="highlight lua"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">local</span> jass = <span class="built_in">require</span> <span class="string">'jass.common'</span></div><div class="line">jass.DisplayTimedTextToPlayer(jass.GetLocalPlayer(), <span class="number">0</span>, <span class="number">0</span>, <span class="number">60.</span>, <span class="string">'hello'</span>)</div></pre></td></tr></table></figure></p>
<p>在新写法中，Lua引擎不在预定义<strong>任何</strong>全局变量，包括jass/japi/jass_ext/slk。你需要在使用之前用require加载它。这样可以保证Lua引擎不会跟你的代码(的变量名)冲突。同时如果某些库你不用的话，就永远不会被加载，减少资源的消耗。</p>
<p>你可以把这段代码添加到所有代码的最前面，这样就能保证新写法和旧写法完全等价，不过我还是建议你使用局部变量，并且去掉不使用的库。<br><figure class="highlight lua"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">jass = <span class="built_in">require</span> <span class="string">'jass.common'</span></div><div class="line">japi = <span class="built_in">require</span> <span class="string">'jass.japi'</span></div><div class="line">slk = <span class="built_in">require</span> <span class="string">'jass.slk'</span></div><div class="line">jass_ext = &#123;&#125;</div><div class="line">jass_ext.hook = <span class="built_in">require</span> <span class="string">'jass.hook'</span></div><div class="line">jass_ext.runtime = <span class="built_in">require</span> <span class="string">'jass.runtime'</span></div></pre></td></tr></table></figure></p>
<p>##控制台激活改变</p>
<p>旧写法<br><figure class="highlight lua"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">jass_ext.EnableConsole()</div></pre></td></tr></table></figure></p>
<p>新写法<br><figure class="highlight lua"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">local</span> runtime = <span class="built_in">require</span> <span class="string">'jass.runtime'</span></div><div class="line">runtime.console = <span class="literal">true</span></div></pre></td></tr></table></figure></p>
<p>同样地你可以使用以下代码来作兼容<br><figure class="highlight lua"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">jass_ext.EnableConsole</span><span class="params">()</span></span></div><div class="line">	<span class="keyword">local</span> runtime = <span class="built_in">require</span> <span class="string">'jass.runtime'</span></div><div class="line">	runtime.console = <span class="literal">true</span></div><div class="line"><span class="keyword">end</span></div></pre></td></tr></table></figure></p>
<p>##|AHbz|的写法被移除</p>
<p>这不是一个标准的Lua语法，在Lua5.3中增加了|作为运算符，所以|AHbz|这种写法在5.3中会产生问题，我思考再三，还是决定将这种写法移除。不过值得庆幸的是，在5.3中加入了一个新函数string.unpackint，他可以将一个字符串当作二进制数组转为一个整数，这恰恰是可以让一个字符串”AHbz”转为整数的’AHbz’（注意我这里使用了Jass的写法）。就像这样</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">string.unpackint(<span class="string">'AHbz'</span>, <span class="number">0</span>, <span class="number">4</span>)</div></pre></td></tr></table></figure>
<p>或者这样<br><figure class="highlight lua"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">ID</span><span class="params">(id)</span></span></div><div class="line">	<span class="keyword">return</span> string.unpackint(id, <span class="number">0</span>, <span class="number">4</span>)</div><div class="line"><span class="keyword">end</span></div><div class="line"></div><div class="line">ID <span class="string">'AHbz'</span></div></pre></td></tr></table></figure></p>
<p>不过目前Lua5.3还有很多不确定性，比如string.unpackint的第三个参数默认值总是8，所以你不能写成这样<br><figure class="highlight lua"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">string.unpackint(<span class="string">'AHbz'</span>)</div></pre></td></tr></table></figure></p>
<p>或许在正式版中会有所改变，所以|AHbz|的写法<strong>暂时</strong>保留，不过最终应该还是会被我去掉的。</p>
</div></article></div></main><footer><div class="paginator"><a href="/2014/04/warcraft3-2048/" class="prev">上一篇</a><a href="/2014/03/everedit-for-jass/" class="next">下一篇</a></div><div id="cloud-tie-wrapper" class="cloud-tie-wrapper"></div><script src="https://img1.cache.netease.com/f2e/tie/yun/sdk/loader.js"></script><script>var url = document.location.href;
if (url.substring(url.length-1) == '/') {
    url = url.substring(0, url.length-1)
};
var cloudTieConfig = {
  url: url,
  sourceId: "",
  productKey: "04f8b460aaca4ca08df51bb3e40f6025",
  target: "cloud-tie-wrapper"
};
var yunManualLoad = true;
Tie.loader("aHR0cHM6Ly9hcGkuZ2VudGllLjE2My5jb20vcGMvbGl2ZXNjcmlwdC5odG1s", true);</script><div class="copyright"><p>© 2014 - 2017 <a href="http://www.ydwe.net">actboy168</a>, powered by <a href="https://hexo.io/" target="_blank">Hexo</a> and <a href="https://github.com/pinggod/hexo-theme-apollo" target="_blank">hexo-theme-apollo</a>.</p></div></footer></div><script async src="//cdn.bootcss.com/mathjax/2.7.0/MathJax.js?config=TeX-MML-AM_CHTML" integrity="sha384-crwIf/BuaWM9rM65iM+dWFldgQ1Un8jWZMuh3puxb8TOY9+linwLoI7ZHZT+aekW" crossorigin="anonymous"></script><script type="text/javascript" src="http://tajs.qq.com/stats?sId=9212054" charset="UTF-8"></script></body></html>