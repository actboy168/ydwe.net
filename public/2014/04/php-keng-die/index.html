<!DOCTYPE html><html><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> 坑爹的php · YDWE官方博客</title><meta name="description" content="坑爹的php - actboy168"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="icon" href="/favicon.png"><link rel="stylesheet" href="/css/apollo.css"><link rel="search" type="application/opensearchdescription+xml" href="http://www.ydwe.net/atom.xml" title="YDWE官方博客"></head><body><div class="wrap"><header><a href="/" class="logo-link"><img src="/favicon.png" alt="logo"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/" target="_self" class="nav-list-link">主页</a></li><li class="nav-list-item"><a href="/archives/" target="_self" class="nav-list-link">目录</a></li><li class="nav-list-item"><a href="/download.html" target="_self" class="nav-list-link">下载</a></li><li class="nav-list-item"><a href="https://github.com/actboy168/YDWE" target="_blank" class="nav-list-link">GITHUB</a></li></ul></header><main class="container"><div class="post"><article class="post-block"><h1 class="post-title">坑爹的php</h1><div class="post-info">Apr 7, 2014</div><div class="post-content"><p>周末研究了一下从c++调用php，看起来是一件很简单的事却折腾了我两天，总之是被坑惨了。虽然php是用c写的，不过看起来开发组只管自己用得溜就算了，完全没有考虑一般使用者的感受。</p>
<a id="more"></a>
<p>以下是我在msvc2010下编译php5.4.27的记录。</p>
<p>##坑之ZTS</p>
<p>php默认启用ZTS(php线程安全)，但ZTS宏却不是默认开启.如果你编译php时没有关掉ZTS，那么使用php api时会得到以下错误<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">error LNK2001: 无法解析的外部符号 __imp__compiler_globals</div><div class="line">error LNK2001: 无法解析的外部符号 __imp__executor_globals</div></pre></td></tr></table></figure></p>
<p>你需要自己定义ZTS<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">#define ZTS</div></pre></td></tr></table></figure></p>
<p>##坑之PHP_WIN32、ZEND_WIN32</p>
<p>完全想不出不通过_WIN32宏来生成PHP_WIN32、ZEND_WIN32宏的理由，总之你是需要自己来定义了。还有为什么会有PHP_WIN32和ZEND_WIN32两个宏呢。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">#define ZEND_WIN32</div><div class="line">#define PHP_WIN32</div></pre></td></tr></table></figure></p>
<p>另外，虽然php不会理会_WIN32宏，但却会理会_WIN64宏。</p>
<p>##坑之ZEND_WIN32_FORCE_INLINE</p>
<p>如果说之前的坑只是懒，那这个坑只能说是逗了。让我们来看看ZEND_WIN32_FORCE_INLINE都干了些什么。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">#undef inline</div><div class="line">#ifdef ZEND_WIN32_FORCE_INLINE</div><div class="line"># define inline __forceinline</div><div class="line">#else</div><div class="line"># define inline</div><div class="line">#endif</div></pre></td></tr></table></figure></p>
<p>注意，默认是没有定义ZEND_WIN32_FORCE_INLINE的，所以当你引用了php的头文件，你代码中inline就会全部失效。c++标准库的头文件中也使用了inline，所以就算你没用inline，一样会让你的代码无法编译。错误通常为<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">error C2491: “std::flush”: 不允许 dllimport 函数 的定义</div><div class="line">error C2491: “std::ws”: 不允许 dllimport 函数 的定义</div></pre></td></tr></table></figure></p>
<p>所以ZEND_WIN32_FORCE_INLINE宏必须被定义，或者删掉这段略逗的代码。</p>
<p>##坑之_USE_32BIT_TIME_T</p>
<p>如果你没定义_WIN64宏，那么php会帮你定义<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">#ifndef _WIN64</div><div class="line"># define _USE_32BIT_TIME_T 1</div><div class="line">#endif</div></pre></td></tr></table></figure></p>
<p>但msvc默认是不定义这个宏的，所以当你在未引用php头文件时，使用c++的头文件，使用的是64位time_t，引用php头文件后就变32位time_t了。错误通常为<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">stat.inl(42): error C2466: 不能分配常量大小为 0 的数组</div></pre></td></tr></table></figure></p>
<p>或者<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">time.inl(36): error C2664: “_ctime32”: 不能将参数 1 从“const time_t *”转换为“const __time32_t *”</div></pre></td></tr></table></figure></p>
<p>解决方法，删掉这段代码。</p>
<p>##坑之ZEND_DEBUG和UNICODE</p>
<p>_zend_executor_globals是php中一个很重要的结构体(也就是EG(xxx)),这个结构体中包含了一个<a href="http://msdn.microsoft.com/en-us/library/windows/desktop/ms724833%28v=vs.85%29.aspx" target="_blank" rel="external">OSVERSIONINFOEX</a>成员,而OSVERSIONINFOEX的长度会根据UNICODE宏的定义与否有所不同，php默认的编译选项是没有定义UNICODE宏的，如果你的工程定义了UNICODE宏，那么你就会获得很多迷のbug。ZEND_DEBUG也会有同样的问题，如果你编译时有–enable-debug，就必须定义ZEND_DEBUG，反之就不能定义。</p>
<p>php完全可以增加编译时的检查，以保证不会有类似的abi错误，但它没有这么做。</p>
<p>##坑之导出的全局变量</p>
<p>你可能无法想象，php不但很随意地使用了全局变量，并且还很随意地把它直接导出了。这种莫名其妙的设定遍地都是，不过我今天要说的是编译的坑。</p>
<p>表面上看，你在c++里直接使用php的头文件并没有什么问题，因为php在每个导出函数前都加了extern “C”，以保证c++编译器能找到php导出的函数。但这个并没有包括它导出的全局变量，所以当你在c++中使用它导出的全局变量时，就会得到一个链接错误。所以你必须给每个你要引用的php头文件加上extern “C”，就像这样<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">extern &quot;C&quot; &#123;</div><div class="line">#include &lt;zend.h&gt;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>显然它原来自己加的extern “C”就没用了，倒不如你就像lua那样宣称我就是要用c，你要用c++就自己加extern “C”得了，做事做一半就不管了，算是个什么意思。</p>
<p>##坑之debug模式</p>
<p>当你编译为debug模式的php，php会为你做很多额外的检查，这本来是一件好事，但它最通常的做法就是直接崩掉，没有任何有用的提示；关掉debug模式的话，是ok的(至少表面看起来ok)。对于这种暴力的提示错误方式，我真不知道该如何招架，或许就php开发组的人玩得溜了。</p>
<hr>
<p><br><br><br><br>最后吐槽下php的代码到处都充斥着丑陋的TSRM宏，无论是否开启ZTS，tsrm_ls都应该作为一个外部参数传入，php不应该也没必要在内部保留自己的状态，无论是否开启ZTS。</p>
</div></article></div></main><footer><div class="paginator"><a href="/2014/04/warcraft3-8mb-patch/" class="prev">上一篇</a><a href="/2014/04/warcraft3-2048/" class="next">下一篇</a></div><div id="cloud-tie-wrapper" class="cloud-tie-wrapper"></div><script src="https://img1.cache.netease.com/f2e/tie/yun/sdk/loader.js"></script><script>var url = document.location.href;
if (url.substring(url.length-1) == '/') {
    url = url.substring(0, url.length-1)
};
var cloudTieConfig = {
  url: url,
  sourceId: "",
  productKey: "04f8b460aaca4ca08df51bb3e40f6025",
  target: "cloud-tie-wrapper"
};
var yunManualLoad = true;
Tie.loader("aHR0cHM6Ly9hcGkuZ2VudGllLjE2My5jb20vcGMvbGl2ZXNjcmlwdC5odG1s", true);</script><div class="copyright"><p>© 2014 - 2017 <a href="http://www.ydwe.net">actboy168</a>, powered by <a href="https://hexo.io/" target="_blank">Hexo</a> and <a href="https://github.com/pinggod/hexo-theme-apollo" target="_blank">hexo-theme-apollo</a>.</p></div></footer></div><script async src="//cdn.bootcss.com/mathjax/2.7.0/MathJax.js?config=TeX-MML-AM_CHTML" integrity="sha384-crwIf/BuaWM9rM65iM+dWFldgQ1Un8jWZMuh3puxb8TOY9+linwLoI7ZHZT+aekW" crossorigin="anonymous"></script><script type="text/javascript" src="http://tajs.qq.com/stats?sId=9212054" charset="UTF-8"></script></body></html>